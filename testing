-- Query to process and transform the data
WITH filtered_data AS (
    SELECT
        line_item_product_code,
        line_item_resource_id
    FROM "ows-costs"."normalized_cost"
    WHERE line_item_resource_id IS NOT NULL
      AND (line_item_resource_id LIKE 'i-%' OR line_item_resource_id LIKE 'arn:%')
),
unique_resource_ids AS (
    SELECT DISTINCT line_item_resource_id AS resource_id
    FROM filtered_data
    WHERE line_item_resource_id LIKE 'i-%'
),
arn_data AS (
    SELECT
        line_item_product_code,
        line_item_resource_id AS arn,
        '' AS resource_id
    FROM filtered_data
    WHERE line_item_resource_id LIKE 'arn:%'
      AND SPLIT_PART(line_item_resource_id, '/', -1) IN (SELECT resource_id FROM unique_resource_ids)
),
resource_id_data AS (
    SELECT
        line_item_product_code,
        '' AS arn,
        line_item_resource_id AS resource_id
    FROM filtered_data
    WHERE line_item_resource_id LIKE 'i-%'
      AND line_item_resource_id IN (SELECT resource_id FROM unique_resource_ids)
),
final_data AS (
    SELECT * FROM arn_data
    UNION ALL
    SELECT * FROM resource_id_data
)
SELECT
    line_item_product_code,
    line_item_resource_id,
    arn,
    resource_id
FROM final_data
UNION ALL
SELECT
    line_item_product_code,
    line_item_resource_id,
    '' AS arn,
    '' AS resource_id
FROM "ows-costs"."normalized_cost"
WHERE line_item_resource_id IS NULL
   OR line_item_resource_id NOT LIKE 'i-%'
   AND line_item_resource_id NOT LIKE 'arn:%';
